name: Dispatcher

on:
  push:
    branches:
      - '**'

jobs:
  dispatch:
    runs-on: self-hosted
    outputs:
      engine: ${{ steps.check.outputs.engine }}
      server: ${{ steps.check.outputs.server }}
      ui: ${{ steps.check.outputs.ui }}
    steps:
      - name: Determine which tests to run
        id: check
        run: |
          BRANCH="${{ github.ref_name }}"
          echo "Branch: $BRANCH"

          ENGINE=false
          SERVER=false
          UI=false

          if [[ "$BRANCH" == *"Engine"* ]]; then
            ENGINE=true
          fi
          if [[ "$BRANCH" == *"Server"* ]]; then
            SERVER=true
          fi
          if [[ "$BRANCH" == *"UI"* ]]; then
            UI=true
          fi

          # Run all on master
          if [[ "$BRANCH" == "master" ]]; then
            ENGINE=true
            SERVER=true
            UI=true
          fi

          echo "engine=$ENGINE" >> $GITHUB_OUTPUT
          echo "server=$SERVER" >> $GITHUB_OUTPUT
          echo "ui=$UI" >> $GITHUB_OUTPUT

  engine:
    needs: dispatch
    if: needs.determine.outputs.engine == 'true'
    uses: ./engine_test.yml
    with:
      branch: ${{ github.ref_name }}
    secrets: inherit

  server:
    needs: dispatch
    if: needs.determine.outputs.server == 'true'
    uses: ./server_test.yml
    with:
      branch: ${{ github.ref_name }}
    secrets: inherit

  ui:
    needs: dispatch
    if: needs.determine.outputs.ui == 'true'
    uses: ./ui_test.yml
    with:
      branch: ${{ github.ref_name }}
    secrets: inherit




